<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Manhwa - Manhwas Haven</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <header>
        <h1><a href="index.html"><span class="manhwas">MANHWAS</span> <span class="haven">HAVEN</span></a></h1>
    </header>

    <main>
        <div id="info"></div>
        <div id="lista"></div>
        <div id="lector"></div>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const nombre = params.get("nombre");
        const API = "https://manhwashaven.onrender.com/api";
        let capitulos = [];

        document.addEventListener("DOMContentLoaded", cargarManhwa);

        async function cargarManhwa() {
            const infoDiv = document.getElementById("info");
            const listaDiv = document.getElementById("lista");

            try {
                const res = await fetch(`${API}/manhwas`);
                const manhwas = await res.json();
                const manhwa = manhwas.find(m => m.nombre === nombre);

                if (!manhwa) {
                    infoDiv.innerHTML = "<p>No se encontró el manhwa solicitado.</p>";
                    return;
                }

                // Encabezado con portada, tipo, demografía y descripción
                infoDiv.innerHTML = `
            <div class="manhwa-header">
              <div class="manhwa-cover">
                <div class="manhwa-type">${manhwa.tipo?.toUpperCase() || "SIN TIPO"}</div>
                <img src="https://manhwashaven.onrender.com${manhwa.portada || ''}" alt="${manhwa.nombre}">
                <div class="manhwa-bottom">${manhwa.demografia || "N/A"}</div>
              </div>
              <div class="manhwa-details">
                <h2>${manhwa.nombre}</h2>
                <p class="descripcion">${manhwa.descripcion || "Sin descripción disponible."}</p>
                <p><strong>Estado:</strong> ${manhwa.estado || "Sin definir"}</p>
                <p><strong>Géneros:</strong> ${manhwa.generos?.join(", ") || "N/A"}</p>
              </div>
            </div>
          `;

                // Cargar capítulos
                const capsRes = await fetch(`${API}/capitulos/${encodeURIComponent(nombre)}`);
                const data = await capsRes.json();
                capitulos = data.capitulos || [];

                if (!capitulos.length) {
                    listaDiv.innerHTML = "<p>No hay capítulos disponibles.</p>";
                    return;
                }

                listaDiv.innerHTML = `
  <h3>Capítulos disponibles</h3>
  <div class="chapter-list">
    ${capitulos.map((c, i) => `
      <div class="chapter-item">
        <img src="https://manhwashaven.onrender.com${c.portada}" alt="${c.nombre}">
        <span>${c.nombre.replace("capitulo-", "Capítulo ")}</span>
        <a href="#" 
           class="leer-link" 
           data-cap="${c.nombre}" 
           data-index="${i}" 
           data-total="${capitulos.length}" 
           data-list='${JSON.stringify(capitulos)}'>Leer</a>
      </div>
    `).join("")}
  </div>
`;


                document.querySelectorAll(".leer-link").forEach(link => {
                    link.addEventListener("click", e => {
                        e.preventDefault();
                        const cap = e.target.dataset.cap;
                        const index = parseInt(e.target.dataset.index);
                        const total = parseInt(e.target.dataset.total);
                        const capitulos = JSON.parse(e.target.dataset.list);
                        mostrarCapitulo(cap, index, total, capitulos);
                    });
                });

            } catch (err) {
                infoDiv.innerHTML = "<p>Error cargando la información del manhwa.</p>";
                console.error(err);
            }
        }

        async function mostrarCapitulo(cap, index, totalCapitulos, capitulos) {
            const lectorDiv = document.getElementById("lector");
            const listaDiv = document.getElementById("lista");
            listaDiv.style.display = "none";

            try {
                const res = await fetch(`${API}/capitulos/imagenes/${encodeURIComponent(cap)}`);
                const data = await res.json();

                lectorDiv.classList.remove("loaded");

                lectorDiv.innerHTML = `
      <div class="nav-buttons">
        <button id="volver">Volver</button>
        <h3>${cap.replace("capitulo-", "Capítulo ")}</h3>
        <div class="chapter-nav">
          <button id="anterior" ${index === 0 ? "disabled" : ""}>⟵ Anterior</button>
          <button id="siguiente" ${index === totalCapitulos - 1 ? "disabled" : ""}>Siguiente ⟶</button>
        </div>
      </div>
      <div class="chapter-viewer">
        ${data.map(img => `<img src="https://manhwashaven.onrender.com${img.url_imagen}" alt="${cap}">`).join("")}
      </div>
    `;

                // Animación
                setTimeout(() => {
                    lectorDiv.querySelector(".chapter-viewer").classList.add("loaded");
                }, 50);

                // Volver a la lista
                document.getElementById("volver").onclick = () => {
                    lectorDiv.innerHTML = "";
                    listaDiv.style.display = "block";
                    window.scrollTo({ top: 0, behavior: "smooth" });
                };

                // Navegación entre capítulos
                document.getElementById("anterior").onclick = () => {
                    mostrarCapitulo(capitulos[index - 1].nombre, index - 1, totalCapitulos, capitulos);
                    window.scrollTo({ top: 0, behavior: "smooth" });
                };
                document.getElementById("siguiente").onclick = () => {
                    mostrarCapitulo(capitulos[index + 1].nombre, index + 1, totalCapitulos, capitulos);
                    window.scrollTo({ top: 0, behavior: "smooth" });
                };

            } catch (err) {
                lectorDiv.innerHTML = "<p>Error cargando las imágenes del capítulo.</p>";
                console.error(err);
            }
        }

    </script>

</body>
</html>


