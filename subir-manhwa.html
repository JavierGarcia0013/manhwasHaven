<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subir Manhwa - MANHWAS HAVEN</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="app.js" defer></script>
</head>
<body>
    <header>
        <h1><a href="index.html"><span class="manhwas">MANHWAS</span> <span class="haven">HAVEN</span></a></h1>
    </header>

    <main class="form-container">
        <h2>📚 Subir nuevo manhwa</h2>

        <form id="subir-form">
            <label>Título:</label>
            <input type="text" id="titulo" required />

            <label>Tipo:</label>
            <select id="tipo">
                <option>Manhwa</option>
                <option>Manga</option>
                <option>Manhua</option>
            </select>

            <label>Demografía:</label>
            <select id="demografia">
                <option>Shonen</option>
                <option>Seinen</option>
                <option>Josei</option>
                <option>Shoujo</option>
            </select>

            <label>Estado:</label>
            <select id="estado">
                <option>En emisión</option>
                <option>Finalizado</option>
                <option>Pausado</option>
            </select>

            <label>¿Es erótico?</label>
            <select id="erotico">
                <option value="No">No</option>
                <option value="Si">Sí</option>
            </select>

            <label>Géneros:</label>
            <div id="generos-container" class="tags" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:8px;"></div>

            <label>Descripción:</label>
            <textarea id="descripcion" rows="4" placeholder="Breve sinopsis..."></textarea>

            <label>Portada (PNG/JPG):</label>
            <input type="file" id="portadaFile" accept="image/*" />

            <button type="submit" class="auth-btn">Subir</button>
        </form>
    </main>

    <script>
        const API = "http://localhost:3000/api/manhwas";
        const usuarioActual = JSON.parse(localStorage.getItem("usuarioActual") || "null");

        // Listas de géneros
        const NO_EROTICOS = [
            "Acción", "Aventura", "Comedia", "Drama", "Fantasía", "Romance",
            "Vida Cotidiana", "Paranormal", "Conmovedor", "Suspenso", "Deportes",
            "Terror", "Ciencia Ficción", "Superhéroes", "Histórico", "Misterio", "Informativo"
        ];

        // Nota: lista para adultos ejemplar y neutra (evita contenido con menores o ilegal)
        const ADULTOS = [
            "Romance adulto", "Sensual", "BDSM", "Fetichismo", "Dominación",
            "Sumisión", "Harem", "Reverse Harem", "Cosplay", "Maduros",
            "Oficina", "Profesor-Adultos", "Maid-Adultos", "Masaje", "Idols-Adultos",
            "Ambientación Histórica Adulta", "Fantasía Adulta", "Tentacular-Ficción",
            "Roleplay", "Exhibicionismo-Ficción"
        ];

        const eroticoSel = document.getElementById("erotico");
        const generosDiv = document.getElementById("generos-container");

        function renderGeneros() {
            const lista = eroticoSel.value === "Si" ? ADULTOS : NO_EROTICOS;
            generosDiv.innerHTML = lista.map(g =>
                `<label style="display:flex;align-items:center;gap:6px">
             <input type="checkbox" name="generos" value="${g}"/> ${g}
           </label>`).join("");
            generosDiv.style.display = "grid";
        }

        eroticoSel.addEventListener("change", renderGeneros);
        document.addEventListener("DOMContentLoaded", renderGeneros);

        async function fileToBase64(file) {
            if (!file) return null;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result); // data:image/*;base64,....
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.getElementById("subir-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!usuarioActual?.token) {
                alert("Debes iniciar sesión como admin para subir.");
                return;
            }

            const titulo = document.getElementById("titulo").value.trim();
            const tipo = document.getElementById("tipo").value;
            const demografia = document.getElementById("demografia").value;
            const estado = document.getElementById("estado").value;
            const erotico = document.getElementById("erotico").value === "Si";
            const descripcion = document.getElementById("descripcion").value.trim();

            const generos = [...document.querySelectorAll('input[name="generos"]:checked')].map(i => i.value);

            const portadaFile = document.getElementById("portadaFile").files[0];
            const portadaBase64 = await fileToBase64(portadaFile); // puede ser null

            // id_usuario viene del login
            const id_usuario = usuarioActual.id;

            try {
                const res = await fetch(`${API}/subir`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${usuarioActual.token}`
                    },
                    body: JSON.stringify({
                        titulo, tipo, demografia, estado,
                        erotico, generos, descripcion,
                        portada: portadaBase64, id_usuario
                    })
                });

                const data = await res.json();
                alert(data.msg || "Listo");
                if (res.ok) e.target.reset();
            } catch (err) {
                console.error(err);
                alert("❌ Error al subir el manhwa.");
            }
        });
    </script>

</body>
</html>
